# Как решать ошибки циклической зависимости

## Правило

В файле, где **определена экспортируемая константа**, все импорты должны указывать напрямую на файл-источник. То есть нельзя импортировать с указанием на индексный файл.  
Таким образом, из списка проблем вы исключите практически неотлавливаемые ошибки "чужих" циклических зависимостей.

## Рекомендация

Все константы проекта перенести в один файл и экспортировать из него напрямую, без участия индекса.  
Преимущества такого подхода:

1. Проще реализовать правило
2. Сразу видно список всех констант, используемых на проекте

## Ошибка циклической зависимости

Если при соблюдении правила возникает ошибка циклической зависимости, то это означает, что для анализа у вас будут следующие входящие:

- файл с конкретной константой
- файл, где возникла ошибка

Ошибка будет связана с тем, что javascript пытается выполнить код с участием этой константы, а константа либо еще не поределена, либо модуль с константой не проинициализирован.

# Как может выглядеть сообщение, когда возникает ошибка циклической зависимости

Для примера возьмем два файла:

файл `a.ts`:

```typescript
import {b} from './b';

export function aFn(): number {
  return b + 1;
}
```

файл `b.ts`:

```typescript
import {aFn} from './a';

export const b = 1 + aFn();
```

## ReferenceError: Cannot access 'ИмяКонстанты' before initialization

В нашем примере такая ошибка возникнет в файле `a.ts`, в случае если последовательность импортов будет следующей:  
импортируем `b.ts`, затем импортируем `a.ts`.

файл `a.ts`:

```typescript
import {b} from './b';

export function aFn(): number {
  return b + 1;
}// <------------ ReferenceError: Cannot access 'b' before initialization
```

## TypeError: Cannot read properties of undefined (reading 'ИмяКонстанты')

В нашем примере такая ошибка возникнет в файле `a.ts`, в случае если последовательность импортов будет следующей:  
импортируем `a.ts`, затем импортируем `b.ts`.

файл `a.ts`:

```typescript
import {b} from './b';

export function aFn(): number {
  return b + 1; // <------------ TypeError: Cannot read properties of undefined (reading 'b')
}
```

---

Пакет, который установлен из npm является гарантированно корректным, т.к. файлы такого пакета могут ссылаться только на файлы внутри этого пакета.  
**Скорее всего ошибочное утверждение!** Проверить.

Некорректный пакет:

1) Два файла пакета ссылаются друг на друга И **один из файлов импортирует константу** из другого
2) Какой-то из файлов пакета импортирует из вне пакета. Таким образом возникает вероятность, что этот импорт из вне где-нибудь в иерархии попадет на некорректный пакет

Пути решения:

1) **Пакет не должен импортировать из-вне**  
   Если это невозможно достичь, то удалить index

2) **Файл не должен импортировать некорректные пакеты** (пакеты, в которых есть импорт из вне)  
   Если это невозможно достичь, тогда импорт внутрь файла надо делать, указав прямую ссылку до файла в пакете

3) **Надо удалить все индексы**  
   Если и останутся зацикливания, то только прямые - между двумя файлами.

Как искать:

по фразе  
`export const`  
проверить, а если функция создана через конст, тоже возникнет проблема?  






